function selfInd = selfInd_smallrect(r, dr, dz)
%
% SELFIND_SMALLRECT
%
%   Compute the self-inductance of a circular conductor with (small)
%   rectangular cross-section.
%
%   L = mu0 * pi * r^2/h * K' where K' = (K - k). K is Nagaoka's K-factor
%   (computed by K_nagaoka). k is determined via interpolation on the data
%   in Tables 22-23.
%
%   Warning: This function is only applicable for short coils with aspect
%            ratio (length / diameter) < 1. The function K_nagaoka will
%            warn the user if this criteria is not satisfied.
%
%   Formula from: Grover. Inductance Calculations: Working Formulas and 
%                 Tables. Dover, 1973. Page 105, Eq. 99.
%
% USAGE: selfInd_smallrect.m
%
% INPUTS:
%
%   r.............mean radius of conductor  [m] (array of length n)
%   dr............full width of conductor   [m] (array of length n)
%   dz........... full height of conductor  [m] (array of length n)
%
% OUTPUTS: 
%
%   selfInd.......self-inductance [H] (array of length n)
%
% AUTHOR: Patrick J. Vail
%
% DATE: 09/13/2016
%
% MODIFICATION HISTORY:
%   Patrick J. Vail: Original File 09/13/2016
%
%.........................................................................

% Magnetic permeability 

mu0 = 4*pi*10^-7;

% Compute Nagaoka's K-factor

K = K_nagaoka(r, dz);

% Compute small k

kl1 = [0.0000 0.0325 0.0633 0.0925 0.1200 0.1458 0.1700 0.1925 0.2133 ...
       0.2325 0.2500 0.0000 0.0316 0.0621 0.0911 0.1186 0.1445 0.1687 ...
       0.1913 0.2123 0.2317 0.2494 0.0000 0.0308 0.0608 0.0896 0.1170 ...
       0.1428 0.1671 0.1898 0.2109 0.2304 0.2484 0.0000 0.0300 0.0594 ...
       0.0879 0.1151 0.1409 0.1651 0.1879 0.2091 0.2288 0.2470 0.0000 ...
       0.0293 0.0581 0.0861 0.1131 0.1388 0.1630 0.1858 0.2071 0.2270 ...
       0.2453 0.0000 0.0286 0.0569 0.0843 0.1109 0.1365 0.1607 0.1835 ...
       0.2048 0.2248 0.2432 0.0000 0.0280 0.0557 0.0826 0.1085 0.1342 ...
       0.1583 0.1810 0.2024 0.2224 0.2410 0.0000 0.0274 0.0546 0.0810 ...
       0.1069 0.1319 0.1558 0.1785 0.1999 0.2199 0.2386 0.0000 0.0269 ...
       0.0535 0.0796 0.1051 0.1297 0.1533 0.1759 0.1973 0.2174 0.2361 ...
       0.0000 0.0264 0.0525 0.0782 0.1033 0.1276 0.1510 0.1732 0.1945 ...
       0.2146 0.2335 0.0000 0.0259 0.0516 0.0769 0.1016 0.1256 0.1487 ...
       0.1706 0.1916 0.2118 0.2308 0.0000 0.0254 0.0507 0.0755 0.0999 ...
       0.1236 0.1464 0.1682 0.1890 0.2091 0.2280 0.0000 0.0250 0.0498 ...
       0.0742 0.0982 0.1216 0.1442 0.1658 0.1866 0.2065 0.2252 0.0000 ...
       0.0246 0.0490 0.0730 0.0966 0.1197 0.1421 0.1635 0.1842 0.2039 ...
       0.2225 0.0000 0.0242 0.0482 0.0719 0.0952 0.1179 0.1400 0.1613 ...
       0.1818 0.2014 0.2199 0.0000 0.0238 0.0474 0.0708 0.0937 0.1161 ...
       0.1380 0.1591 0.1794 0.1988 0.2173 0.0000 0.0234 0.0467 0.0697 ...
       0.0923 0.1144 0.1360 0.1569 0.1770 0.1963 0.2147 0.0000 0.0230 ...
       0.0460 0.0687 0.0910 0.1128 0.1341 0.1548 0.1747 0.1939 0.2121 ...
       0.0000 0.0227 0.0453 0.0677 0.0897 0.1113 0.1323 0.1527 0.1725 ...
       0.1915 0.2096 0.0000 0.0224 0.0447 0.0667 0.0884 0.1097 0.1305 ...
       0.1507 0.1704 0.1892 0.2071 0.0000 0.0221 0.0441 0.0658 0.0872 ...
       0.1082 0.1288 0.1489 0.1683 0.1869 0.2047];
   
kl1 = reshape(kl1, 11, 21)';

kl2 = [0.2658 0.2800 0.2925 0.3033 0.3125 0.3200 0.3258 0.3300 0.3325 ...
       0.3333 0.2655 0.2800 0.2928 0.3040 0.3135 0.3213 0.3275 0.3321 ...
       0.3351 0.3363 0.2648 0.2795 0.2926 0.3040 0.3138 0.3221 0.3287 ...
       0.3337 0.3371 0.3388 0.2636 0.2786 0.2920 0.3037 0.3139 0.3225 ...
       0.3294 0.3349 0.3386 0.3408 0.2621 0.2773 0.2910 0.3031 0.3136 ...
       0.3225 0.3298 0.3356 0.3397 0.3423 0.2803 0.2758 0.2897 0.3021 ...
       0.3129 0.3221 0.3298 0.3359 0.3404 0.3434 0.2582 0.2739 0.2881 ...
       0.3007 0.3118 0.3213 0.3294 0.3359 0.3408 0.3441 0.2559 0.2718 ...
       0.2862 0.2991 0.3104 0.3202 0.3286 0.3355 0.3407 0.3445 0.2535 ...
       0.2695 0.2841 0.2972 0.3088 0.3189 0.3276 0.3347 0.3403 0.3445 ...
       0.2509 0.2671 0.2818 0.2951 0.3070 0.3173 0.3263 0.3337 0.3397 ...
       0.3442 0.2483 0.2645 0.2794 0.2929 0.3050 0.3156 0.3248 0.3326 ...
       0.3389 0.3436 0.2456 0.2619 0.2769 0.2906 0.3028 0.3137 0.3231 ...
       0.3311 0.3377 0.3428 0.2428 0.2592 0.2743 0.2881 0.3005 0.3116 ...
       0.3213 0.3295 0.3363 0.3417 0.2400 0.2564 0.2716 0.2856 0.2981 ...
       0.3093 0.3192 0.3277 0.3348 0.3404 0.2373 0.2536 0.2689 0.2830 ...
       0.2957 0.3070 0.3171 0.3258 0.3331 0.3390 0.2346 0.2509 0.2662 ...
       0.2804 0.2932 0.3046 0.3149 0.3238 0.3313 0.3375 0.2320 0.2483 ...
       0.2636 0.2777 0.2906 0.3022 0.3126 0.3217 0.3294 0.3358 0.2294 ...
       0.2456 0.2609 0.2750 0.2880 0.2998 0.3103 0.3195 0.3274 0.3340 ...
       0.2268 0.2430 0.2582 0.2724 0.2855 0.2973 0.3079 0.3172 0.3253 ...
       0.3321 0.2242 0.2404 0.2556 0.2698 0.2829 0.2949 0.3055 0.3149 ...
       0.3231 0.3301 0.2217 0.2378 0.2530 0.2672 0.2804 0.2929 0.3031 ...
       0.3126 0.3209 0.3281];

kl2 = reshape(kl2, 10, 21)';

ks1 = [0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 ...
       0.0000 0.0000 0.0000 0.0045 0.0090 0.0134 0.0178 0.0226 0.0269 ...
       0.0314 0.0359 0.0398 0.0436 0.0000 0.0077 0.0153 0.0229 0.0304 ...
       0.0379 0.0453 0.0527 0.0601 0.0674 0.0745 0.0000 0.0098 0.0194 ...
       0.0291 0.0387 0.0482 0.0576 0.0669 0.0763 0.0855 0.0944 0.0000 ...
       0.0114 0.0228 0.0341 0.0454 0.0566 0.0677 0.0786 0.0894 0.1000 ...
       0.1105 0.0000 0.0128 0.0256 0.0383 0.0510 0.0635 0.0759 0.0881 ...
       0.1001 0.1120 0.1237 0.0000 0.0140 0.0280 0.0419 0.0557 0.0694 ...
       0.0829 0.0962 0.1092 0.1221 0.1347 0.0000 0.0151 0.0301 0.0451 ...
       0.0598 0.0745 0.0889 0.1031 0.1172 0.1309 0.1443 0.0000 0.0160 ...
       0.0319 0.0478 0.0634 0.0789 0.0942 0.1092 0.1240 0.1385 0.1526 ...
       0.0000 0.0168 0.0335 0.0501 0.0666 0.0828 0.0988 0.1146 0.1300 ...
       0.1452 0.1599 0.0000 0.0175 0.0349 0.0522 0.0694 0.0863 0.1030 ...
       0.1194 0.1354 0.1511 0.1663 0.0000 0.0182 0.0362 0.0541 0.0720 ...
       0.0895 0.1068 0.1237 0.1403 0.1563 0.1720 0.0000 0.0188 0.0374 ...
       0.0559 0.0743 0.0924 0.1102 0.1276 0.1446 0.1611 0.1772 0.0000 ...
       0.0193 0.0385 0.0576 0.0764 0.0950 0.1132 0.1311 0.1485 0.1655 ...
       0.1819 0.0000 0.0198 0.0395 0.0591 0.0784 0.0974 0.1160 0.1343 ...
       0.1521 0.1694 0.1861 0.0000 0.0203 0.0404 0.0605 0.0802 0.0996 ...
       0.1186 0.1373 0.1554 0.1729 0.1899 0.0000 0.0207 0.0413 0.0617 ...
       0.0818 0.1016 0.1210 0.1400 0.1584 0.1762 0.1934 0.0000 0.0211 ...
       0.0421 0.0629 0.0833 0.1035 0.1232 0.1424 0.1611 0.1792 0.1966 ...
       0.0000 0.0215 0.0428 0.0639 0.0847 0.1052 0.1252 0.1447 0.1637 ...
       0.1820 0.1995 0.0000 0.0218 0.0435 0.0649 0.0860 0.1068 0.1271 ...
       0.1469 0.1661 0.1846 0.2022 0.0000 0.0221 0.0441 0.0658 0.0872 ...
       0.1082 0.1288 0.1489 0.1683 0.1869 0.2047];
   
ks1 = reshape(ks1, 11, 21)';

ks2 = [0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 ...
       0.0000 0.0484 0.0529 0.0572 0.0613 0.0653 0.0692 0.0730 0.0767 ...
       0.0803 0.0839 0.0816 0.0885 0.0953 0.1020 0.1085 0.1149 0.1211 ...
       0.1272 0.1331 0.1388 0.1023 0.1120 0.1204 0.1287 0.1368 0.1447 ...
       0.1523 0.1597 0.1668 0.1736 0.1208 0.1308 0.1406 0.1501 0.1594 ...
       0.1684 0.1771 0.1854 0.1933 0.2009 0.1350 0.1460 0.1568 0.1673 ...
       0.1775 0.1874 0.1968 0.2058 0.2142 0.2224 0.1471 0.1590 0.1706 ...
       0.1819 0.1928 0.2032 0.2132 0.2226 0.2315 0.2399 0.1574 0.1701 ...
       0.1823 0.1942 0.2057 0.2166 0.2269 0.2366 0.2458 0.2544 0.1663 ...
       0.1796 0.1924 0.2048 0.2167 0.2279 0.2384 0.2484 0.2577 0.2664 ...
       0.1742 0.1880 0.2012 0.2140 0.2262 0.2377 0.2484 0.2585 0.2679 ...
       0.2766 0.1811 0.1953 0.2089 0.2220 0.2345 0.2462 0.2571 0.2672 ...
       0.2766 0.2852 0.1872 0.2018 0.2157 0.2291 0.2418 0.2536 0.2645 ...
       0.2748 0.2842 0.2926 0.1927 0.2076 0.2218 0.2354 0.2482 0.2601 ...
       0.2712 0.2814 0.2907 0.2990 0.1977 0.2128 0.2272 0.2409 0.2539 ...
       0.2659 0.2770 0.2872 0.2964 0.3046 0.2022 0.2175 0.2321 0.2459 ...
       0.2589 0.2710 0.2821 0.2923 0.3014 0.3095 0.2062 0.2217 0.2365 ...
       0.2504 0.2634 0.2755 0.2866 0.2968 0.3058 0.3137 0.2098 0.2255 ...
       0.2404 0.2544 0.2675 0.2796 0.2907 0.3007 0.3096 0.3174 0.2132 ...
       0.2291 0.2440 0.2581 0.2712 0.2833 0.2943 0.3042 0.3130 0.3206 ...
       0.2163 0.2323 0.2473 0.2614 0.2745 0.2866 0.2976 0.3074 0.3160 ...
       0.3234 0.2191 0.2352 0.2503 0.2644 0.2776 0.2896 0.3005 0.3102 ...
       0.3186 0.3259 0.2217 0.2378 0.2530 0.2672 0.2804 0.2924 0.3031 ...
       0.3126 0.3209 0.3281];
   
ks2 = reshape(ks2, 10, 21)';

klong = [kl1 kl2];
kshrt = [ks1 ks2];

xvals = 0:0.05:1.00;
yvals = 0:0.05:1.00;

k = zeros(1,length(r));

for ii = 1:length(r)
    if dr(ii)/dz(ii) < 1 % thin  long coil
        k(ii) = interp2(xvals, yvals, klong, dr(ii)/(2*r(ii)), ...
            dr(ii)/dz(ii));
    else                 % short thick coil
        k(ii) = interp2(xvals, yvals, kshrt, dr(ii)/(2*r(ii)), ...
            dz(ii)/dr(ii));
    end
end

selfInd = mu0 * pi * (r.*r)./dz .* (K-k);

end
